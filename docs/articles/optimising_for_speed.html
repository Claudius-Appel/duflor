<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="duflor">
<title>optimising_for_speed • duflor</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="optimising_for_speed">
<meta property="og:description" content="duflor">
<meta property="og:image" content="https://Claudius-Appel.github.io/duflor/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">duflor</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9026</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/duflor.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/general_workflow.html">general_workflow</a>
    <a class="dropdown-item" href="../articles/optimising_for_speed.html">optimising_for_speed</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Claudius-Appel/duflor/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>optimising_for_speed</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Claudius-Appel/duflor/blob/HEAD/vignettes/optimising_for_speed.Rmd" class="external-link"><code>vignettes/optimising_for_speed.Rmd</code></a></small>
      <div class="d-none name"><code>optimising_for_speed.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Claudius-Appel.github.io/duflor/">duflor</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Attaching duflor version 0.0.1.9026 from library C:/Users/Claudius Main/AppData/Local/R/cache/R/renv/library/duflor-c6543f5b/R-4.3/x86_64-w64-mingw32.</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Image-Analysis is a resource-consuming process. To give some context,
this package was built and designed for the analysis of up to 200 images
with a resolution of 6000x4000=24.000.000 pixels. As each pixel is
represented in HSV-color space, each image consists of a
multidimensional matrix with 72.000.000 elements. As a result, each full
image consumes <code>576</code> MB of RAM.<br>
The likely effectiveness of any measure outlined on this article thus
heavily depends on your preexisting specs and workflow-requirements.</p>
<p>This problem gets accentuated by various factors:</p>
<ol style="list-style-type: decimal">
<li>General
<ol style="list-style-type: decimal">
<li>number of images</li>
<li>image dimensions</li>
<li>Programming Language used for iteration-heavy steps</li>
<li>Number of spectra extracted per image</li>
</ol>
</li>
<li>User-specific
<ol style="list-style-type: decimal">
<li>Specifications of the machine running the analysis-process</li>
<li>Parallelised computing</li>
</ol>
</li>
</ol>
<p>Not all of these factors can be addressed by the package
author<!--, and some of these can only be addressed after careful benchmarking-->.</p>
<p>Within the scope of this page, <code>resources</code> is a general
term for any one of the following:</p>
<ul>
<li>RAM (both available and total)</li>
<li>CPU Clock speed</li>
<li>Storage speed</li>
</ul>
<p>Finally, most of the aspects listed in this article are merely listed
for the sake of completeness, as they are <em>very</em> generalized and
should not be “new” to the reader.</p>
</div>
<div class="section level2">
<h2 id="general">1. General<a class="anchor" aria-label="anchor" href="#general"></a>
</h2>
<p>Steps and advice outlined in this section are considered to hold true
regardless of the PC’s specifications.</p>
<div class="section level3">
<h3 id="number-of-images">1.1 Number of images<a class="anchor" aria-label="anchor" href="#number-of-images"></a>
</h3>
<p>It is pretty self-explanatory that the analysis of 400 images will
require considerably more resources than the analysis of fewer
images.</p>
</div>
<div class="section level3">
<h3 id="image-dimensions">1.2 Image dimensions<a class="anchor" aria-label="anchor" href="#image-dimensions"></a>
</h3>
<p>It should come as no surprise that smaller images will be processed
faster, because less pixels must be checked against any set of color
boundaries.<br>
As a nice bonus, smaller images also have fewer pixels which can be
considered a potential success, and thus the resulting data-objects
<em>can</em> be smaller<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Of course, this is only partially true for well-defined
image subsets of an image, as this &lt;em&gt;should&lt;/em&gt; return the same
number of relevant hits as the large image, while reducing the chance of
adding false-positives.&lt;/p&gt;"><sup>1</sup></a>.</p>
</div>
<div class="section level3">
<h3 id="programming-language-used-for-iteration-heavy-steps">1.3 Programming Language used for iteration-heavy steps<a class="anchor" aria-label="anchor" href="#programming-language-used-for-iteration-heavy-steps"></a>
</h3>
<p>First things first - R is completely fine for a lot of tasks. And
rewriting stuff in C++ can help, but may not always help. In general, a
re-implementation in C++ is only useful if the code you re-write needs a
stupid amount of iterations, or invokes recursion. Within the scope of
this package, the process of determining for every pixel if it is part
of either one range or another can be utterly slow when implemented in
raw R-code. As a central and important step, quantifying matches for
several HSV-ranges (e.g. ‘drought’-pixels,‘green’ pixels,
‘identifier’-pixels, …) further increases the time-cost. On the authors
laptop (mobile Ryzen 5500U with 16GB total RAM), the mean execution time
of 32 sequential analyses of the same image (dimensions 6000x4000
pixels) took</p>
<ul>
<li>R: ~4.02279 [s/iteration]</li>
<li>cpp: ~2.01527 [s/iteration]</li>
<li>cpp_optimised: ~0.594039 [s/iteration]</li>
</ul>
<p>respectively. Needless to say, extrapolating this over 200 images
will snowball appropriately. It could be argued that the slower
implementation(s) should not be part of the package at all; however they
serve as an important stepping-stone for understanding the more
optimised cpp-implementation(s).</p>
<p>Loading is done in Cpp via the <a href="https://cimg.eu/" class="external-link"><code>cImg</code></a>-library via the R-package
<a href="https://github.com/asgr/imager" class="external-link"><code>Imager</code></a>. To
quantify the green leaf-area or root-area in an image, every pixel in
the image must be checked, This can and will take time, especially on
high-resolution images. To counterbalance this, this step is implemented
in C++ via the <a href="https://www.rcpp.org/" class="external-link"><code>Rcpp</code></a>-package, since
iterating over large matrices and checking each value against a
condition is <em>substantially</em> faster in C++ than in R.</p>
</div>
<div class="section level3">
<h3 id="number-of-spectra-extracted-per-image">1.4 Number of spectra extracted per image<a class="anchor" aria-label="anchor" href="#number-of-spectra-extracted-per-image"></a>
</h3>
<p>Similarly to <a href="#id_1.1-number-of-images">1.1</a>, the number
of spectra which have to be extracted for each image increases
execution-time. In principal, the factor would be relative to the number
of spectra; however benchmarks on my end don’t support this trend.
However, as I don’t have the hardware required to run benchmarks at full
efficiency, I cannot verify if this assumption actually holds.</p>
</div>
</div>
<div class="section level2">
<h2 id="user-specific-changes">2. User-specific changes<a class="anchor" aria-label="anchor" href="#user-specific-changes"></a>
</h2>
<div class="section level3">
<h3 id="specifications-of-the-machine-running-the-analysis-process">2.1 Specifications of the machine running the analysis-process<a class="anchor" aria-label="anchor" href="#specifications-of-the-machine-running-the-analysis-process"></a>
</h3>
<p>This section gives a brief overview on which parts of a computer
running this package for analysis tends to get stressed the most, and is
intended as a <em>very simple</em> baseline.</p>
<ul>
<li><p>RAM (a lot of number-crunching)</p></li>
<li><p>CPU (a lot of number-crunching)</p></li>
<li><p>GPU</p></li>
</ul>
<p>A proper CPU is important, and so is a decent amount of RAM. It
should be noted that a parallelised evaluation requires
<strong>significantly</strong> more RAM., <em>especially</em> if the
code is run in parallel. See [2.2 Parallelised computing] for more
details.</p>
</div>
<div class="section level3">
<h3 id="paralellised-computing">2.2 Paralellised computing<a class="anchor" aria-label="anchor" href="#paralellised-computing"></a>
</h3>
<p>Parallelisation is a simple™ solution to computations which take a
lot of time. Simple in principal, somewhat complicated in detail.
However, the in-depth fine details of how and why parallelisation works
are beyond the scope of this article (and to an extend, its author).</p>
<p>While the RAM-requirements are proportional to the dimensions of the
analysed images, the required RAM-space increases significantly under
parallelisation. When you parallelise the analysis-process, you
essentially exchange RAM-usage for computational speed. Depending on the
OS running the code, the hunger for RAM is higher, because different
OS’s have different computational backends available.</p>
<p>A so-called <code>socket</code>-backend can be run on Windows, MacOS
and Linux.<br>
It works by separately exporting the required environment (variables,
functions, hidden objects, loaded packages, etc.) from the
master-process to every designated worker, which work secluded from each
other. When a worker finishes its workload, it must signal back to the
master-process that it has finished. Once all workers are done, their
results can be collected by the master, combined into a collective
output format, and used as a “normal” variable from there. The major
disadvantage is the significant overhead accumulating by this
back-and-forth, and thus a <code>socket</code>-cluster is
<strong>slow</strong> (compared to the <code>fork</code>-backend
described below). For the reasons described above, a
<code>socket</code>-backend also heavily increases RAM-usage (linearly
with the number of workers).</p>
<p>On the other hand, the <code>fork</code>-backend runs significantly
faster. Instead of duplicating all data and providing a unique copy to
each worker-process, each worker gains access to the master’s
environment. As a consequence, the significant overhead of duplicating
the environment can be ignored, and workers instead just return their
respective results to the master process. Unfortunately, <strong>this
backend is not available on windows</strong>. As an additional side
note, machine-clusters cannot use <code>fork</code>-backends.</p>
<p>A final warning: A backend with too many workers compared to the
amount of available RAM can and will starve the PC out of RAM. Without
free RAM, no other processes will be able to run, thus halting
essentially all other currently running processes. In certain cases, it
can also crash the system.</p>
<p>For a similar reason, even if the provided amount of RAM is not an
issue, one should also not declare a cluster using <em>all</em>
available cores.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Claudius Appel.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
